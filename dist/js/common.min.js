angular.module("directives",[]).directive("chart",[function(){function a(a,b,c){var d=c.width,e=c.height,f=c.type,g={top:20,right:30,bottom:30,left:60},h=d-g.left-g.right,i=e-g.top-g.bottom,j="line"===f,k=d3.scale.ordinal().domain(b.map(function(a){return a.month}));j?k.rangePoints([0,h],0):k.rangeRoundBands([0,h],.1);var l=d3.min(b,function(a){return a.value}),m=d3.max(b,function(a){return a.value});0>m&&(m=0),l>0&&(l=0);var n=d3.scale.linear().domain([l,m]).range([i,0]),o=d3.svg.axis().scale(k).orient("top"),p=d3.svg.axis().scale(n).ticks(10).tickSize(-h,0).orient("left"),q=d3.select(a).append("svg").attr("width",d).attr("height",e).append("g").attr("transform","translate("+g.left+","+g.top+")");if(q.append("g").attr("class","y axis").call(p).append("text").attr("transform","rotate(-90)").attr("y",-40).attr("dy",".71em").style("text-anchor","end").text("Billions of dollars"),j){var r=d3.svg.line().x(function(a){return k(a.month)}).y(function(a){return n(a.value)});q.append("path").attr("class","line").attr("d",function(){return r(b)}),q.selectAll("circle").data(b).enter().append("circle").attr("cx",function(a){return k(a.month)}).attr("cy",function(a){return n(a.value)}).attr("r",3)}else q.selectAll("rect").data(b).enter().append("g").attr("transform",function(a){return"translate("+k(a.month)+",0)"}).append("rect").attr("class","bar").attr("y",function(a){return value=a.value,n(value>=0?value:0)}).attr("width",k.rangeBand()).attr("height",0).attr("height",function(a){return Math.abs(n(0)-n(a.value))});var s=q.append("g");s.attr("class","x axis").attr("transform","translate(0,"+parseInt(n(0))+")").call(o).append("text").attr("x",h).attr("y",10).attr("dy",".71em").style("text-anchor","end").text("[months]"),s.selectAll(".tick text").style("text-anchor",j?"start":"middle")}return{restrict:"AE",templateUrl:"dist/tpl/directives/chart-directive.html",replace:!0,scope:{data:"=sourceData"},link:function(b,c,d){function e(){return c.find("svg").remove(),b.data.length?void a(c[0],b.data,{type:b.chartType,width:d.width,height:d.height}):!1}b.chartTypes=["line","bar"],b.chartType=b.chartTypes[1],b.$watch("data",function(a){b.data=a,c.find("svg").remove(),a.length&&e()},!0),b.$watch("chartType",function(){e()})}}}]).directive("grid",[function(){return{restrict:"AE",templateUrl:"dist/tpl/directives/data-grid-directive.html",replace:!0,scope:{report:"=sourceData",toUpdate:"=update"},controller:["$scope","messenger",function(a,b){a.reportData=angular.copy(a.report.data),a.save=function(){a.report.data=a.reportData,b.log("Sending request..."),a.report.$update(function(){a.editReport.$setPristine(),b.log("Report data saved")})},a.addRow=function(){a.editReport.$setDirty(),a.reportData.push({month:"",value:0})},a.remove=function(b){a.reportData.splice(b,1),a.editReport.$setDirty()},a.revert=function(){b.log("Sending request..."),a.report.$get().then(function(c){a.toUpdate=c.data,a.reportData=c.data,a.editReport.$setPristine(),b.log("Report data restored from database")})}}]}}]),angular.module("filters",[]).filter("capitalize",function(){return function(a){function b(a){var b=a.toLowerCase();return b.replace(/(^| )(\w)/g,function(a){return a.toUpperCase()})}return b(a)}}),angular.module("services",[]).factory("reportsDbResource",["$resource","MONGOLAB_CONFIG",function(a,b){return function(c){return a("https://api.mongolab.com/api/1/databases/reportsdb/collections/"+c+"/:id",{apiKey:b.API_KEY,id:"@_id.$oid"},{update:{method:"PUT"}})}}]).factory("authenticate",["$http","$q","$state","$rootScope","messenger",function(a,b,c,d,e){return OAuth.initialize("eGdqaQpGexXG5mJQfD5W8ctPHq8"),{login:function(){var a=b.defer();null===localStorage.getItem("token")&&OAuth.popup("google",{cache:!0}).done(function(b){localStorage.setItem("token",b.access_token),a.resolve(!0)}).fail(function(){e.log("cannot log in")});var c=a.promise;return c.then(function(){d.logged=!0,e.log("Logged in")}),c},logout:function(){localStorage.removeItem("token"),d.logged=!1,e.log("Logged out"),c.go("home").then(function(a){d.$broadcast("$stateChangeSuccess",a,null)})},isLogged:function(){return null!==localStorage.getItem("token")},validateToken:function(){var b=this;return a.get("https://www.googleapis.com/oauth2/v1/tokeninfo",{params:{access_token:localStorage.getItem("token")}}).error(function(){e.log("invalid token"),b.logout()})}}}]).factory("messenger",["$rootScope","$timeout",function(a,b){return{log:function(c){a.message=c,b(function(){a.message=""},3e3)}}}]);